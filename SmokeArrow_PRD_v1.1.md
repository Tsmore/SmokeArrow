# PRD: 喫煙所どっち？ — 最寄り喫煙所 方向ナビ（矢印＋距離＋広告）
Version: 1.1  
Owner: （記入）  
プロジェクト名: SmokeArrow  
アプリ表示名: 喫煙所どっち？  
Last Updated: 2026-01-11  

---

## 1. 概要（Summary）
**喫煙所どっち？**は、ユーザーの現在地から**最も近い喫煙所**の方向を、**単一画面の矢印**で直感的に提示するiOSアプリである。  
MVPはリリーススピードを優先し、喫煙所のデータソースは**MapKit（ローカル検索）**を採用する。  
検索範囲を順次拡大する仕様に伴い、ユーザーが「遠い場所」を案内されていることを判断できるよう、画面上に**喫煙所までの距離**を表示する。  
また収益化のため、画面下部に**バナー広告**を常時表示する（機能体験を阻害しない配置・挙動を要件化）。

---

## 2. 背景・課題（Problem）
- 出先で喫煙所を探す際、地図アプリは情報量が多く、歩行中に扱いづらい。
- 喫煙所は駅前/商業施設周辺などに点在し、初見の土地では見つけにくい。
- MVPで検索範囲を段階拡大する場合、「最寄り」と言いつつ結果が遠距離になる可能性があり、ユーザーが納得しづらい。
- 広告を入れるとUIが窮屈になり、矢印の視認性・操作性を損なうリスクがあるため、広告表示の非機能要件が重要。

---

## 3. 目的（Goals）
1. 起動後すぐに「行くべき方向」を矢印で提示し、探索コストを最小化する。
2. 遠距離案内になっている場合でも、距離表示によりユーザーが意思決定できる（行く/諦める/他手段へ切替）。
3. 画面遷移なし・操作最小で成立する体験を提供する。
4. 収益化としてバナー広告を導入しつつ、**コア体験（矢印＋距離）の阻害を最小化**する。

## 4. 非目的（Non-Goals / Out of Scope）
MVPでは実装しない：
- 地図表示、リスト表示、写真/レビュー
- ルート案内（徒歩経路最短）・ターンバイターン
- お気に入り、履歴、ログイン/アカウント
- ユーザー投稿（喫煙所の追加/編集）
- バックグラウンド常時測位
- インタースティシャル広告／リワード広告（MVPではバナーのみ）

---

## 5. ターゲットユーザー（Target Users）
- 外出・移動が多い喫煙者（20–50代想定）
- 「今どっち？」を瞬時に知りたい
- 操作は最小、歩行中でも視認できるUIが望ましい

---

## 6. ユースケース（Use Cases）
1. 駅に着いて、最寄り喫煙所へ向かいたい（起動→矢印方向へ移動）
2. 商業施設周辺で喫煙所が見つからず焦っている（距離を見て判断）
3. 位置情報がオフ/拒否（許可を促し、許可後すぐ利用）
4. 近隣で検索ヒットしない（範囲拡大→それでも無い場合は明示）
5. 広告が表示/非表示（在庫なし・ネットワーク不安定）でも、矢印と距離の体験が維持される

---

## 7. 体験（UX）・画面仕様（Single Screen）
### 7.1 画面構成（1画面・常時表示）
- **中央：矢印**（目的地方向を指す）
- **矢印の下：距離表示**（例：「約 230 m」「約 1.4 km」）
- **下部（広告領域の上）：状態メッセージ（必要時のみ）**  
  - 権限未許可、測位中、検索中、見つからない、精度低 など
- **最下部：バナー広告**（セーフエリア内に固定）

※画面遷移は行わない。必要なガイダンスは同一画面内で完結させる。  
※広告は**矢印・距離の視認を妨げない**こと（レイアウト・最小高さ・失敗時挙動を要件化）。

### 7.2 表示ルール（距離）
- 表示形式：
  - 0–999m：`約 {10m単位} m`（例：`約 230 m`）
  - 1.0km以上：`約 {0.1km単位} km`（例：`約 1.4 km`）
- 更新頻度：最大1Hz（過剰なちらつきを抑える）
- 表示抑制（任意・推奨）：前回からの差分が小さい場合は更新しない（例：±10m未満は更新しない）

### 7.3 矢印挙動（方向）
- 矢印は「**ユーザーが端末上方向へ向けて進むべき方角**」を示す。
- 角度計算（概念）：  
  - `bearing = 現在地→目的地の方位角(0–360°)`  
  - `relativeAngle = bearing - deviceHeading`（-180°～+180°に正規化）
- 安定化：急なジャンプを抑えるため**平滑化（フィルタ）**を適用する。

### 7.4 広告表示（バナー）UX要件
- 広告は**画面最下部**に固定し、iPhoneのホームインジケータ等を考慮して**Safe Area**内に収める。
- 広告領域は**固定高さ**（例：標準バナー相当）を確保し、
  - 広告ロード失敗/在庫なしでも**レイアウトが大きくジャンプしない**（矢印位置が急変しない）。
- 広告ロードはコア体験を阻害しない：
  - 位置取得・検索・矢印表示は広告ロードの成否に依存しない（非同期、失敗しても継続）。
- 広告表示時も**矢印と距離が第一視認対象**であること（広告は補助要素）。

---

## 8. 機能要件（Functional Requirements）
### 8.1 位置情報取得
- 権限：**When In Use**（前景利用）のみ。
- 取得モード：MVPは前景のみで測位。バックグラウンド常時測位は行わない。
- 精度監視：水平精度が著しく悪い場合は「精度低」状態を表示し、ターゲット切替などを抑制する。

### 8.2 方位（コンパス）取得
- 端末方位（heading）を利用し矢印を回転。
- headingが不安定/取得不可の場合：
  - 代替として移動方向（course）が得られる場合は利用。
  - それも不可の場合は矢印を固定（上向き）＋「方位取得不可」メッセージ。

### 8.3 喫煙所検索（MapKit）
- MapKitのローカル検索を使用し、現在地周辺を検索して候補を取得する。
- 検索クエリ（暫定）：`"喫煙所"`  
  ※将来的に `"smoking area"` 等の併用、地域別最適化を検討（MVP外）。

### 8.4 検索範囲の順次拡大（段階探索）
- 初期半径：**1km**
- 拡大ステップ：**2km → 5km**
- 各ステップのタイムアウト：例）2秒（応答性優先。値は実装で調整）
- いずれでも見つからない場合：**「付近に喫煙所が見つかりません」**を表示。

> 重要：順次拡大により遠距離結果になるリスクは、距離表示によってユーザーが認知・判断できることを前提とする。

### 8.5 「最寄り」判定ロジック
- 候補の中から**直線距離**が最小の地点を最寄りとする（MVP）。
- 同距離近傍が複数の場合の安定化：
  - 距離差が僅少の場合は現在ターゲットを維持（ヒステリシス）。
  - 安定ソート（名称/座標など）で結果の揺れを抑える。

### 8.6 再検索・ターゲット更新条件（揺れ対策）
- 再検索条件（例）：
  - 50m以上移動、または 60秒経過、または精度が改善したタイミング
- ターゲット切替条件（例）：
  - 新候補が現ターゲットより **10%以上近い** 場合のみ切替（ヒステリシス）

### 8.7 キャッシュ（任意・推奨）
- 直近の検索結果を短時間キャッシュ（例：5分）し、ネットワーク/検索失敗時のフォールバックに使用。
- キャッシュ使用時は「取得済み」扱いとして矢印・距離表示を継続。

### 8.8 広告表示（バナー）
- 広告は**バナー形式**で、画面最下部に常時表示する（Safe Area内）。
- 依存関係：広告ロードの成否が、位置取得/検索/矢印表示/距離表示をブロックしてはならない。
- 失敗時挙動：
  - 広告がロードできない場合でも、広告領域は保持し、アプリの主要UIが揺れない。
  - ただし運用上の要請があれば、将来的に「一定時間失敗が続く場合に領域を折りたたむ」を検討（MVP外）。
- 広告クリック：OS/SDK標準の遷移（アプリ内WebView/外部ブラウザ等）に準拠し、アプリをクラッシュさせない。
- 表示頻度/リフレッシュ：利用SDKの推奨設定に従う（MVPはデフォルト）。
- 位置情報の広告利用：MVPでは**広告ターゲティング目的で位置情報を渡さない**（コア機能用途のみ）。

---

## 9. 状態設計（State Machine）
同一画面内で状態遷移する（広告は独立コンポーネントとして扱い、コア状態に干渉させない）。

### 9.1 コア状態
1. **権限未許可**
   - 表示：矢印/距離なし、許可を促すメッセージ

2. **測位中**
   - 表示：矢印グレーアウト（任意）、距離非表示 or `--`

3. **検索中**
   - 表示：矢印グレーアウト（任意）、距離 `--`、メッセージ「検索中…」

4. **案内中（正常）**
   - 表示：矢印＋距離

5. **精度低**
   - 表示：矢印＋距離（ただし更新は抑制）、メッセージ「測位精度が低い可能性」

6. **見つからない**
   - 表示：矢印/距離なし、メッセージ「付近に喫煙所が見つかりません（最大5km）」

### 9.2 広告状態（独立）
- **広告ロード中**：プレースホルダ表示（もしくは空）
- **広告表示中**
- **広告失敗/在庫なし**：空表示（領域は保持）
- **ネットワーク不可**：空表示（領域は保持）

---

## 10. 非機能要件（Non-Functional Requirements）
### 10.1 パフォーマンス
- 起動→「案内中」まで：中央値 2秒目標（環境依存のため計測して調整）
- UI更新：方向・距離は最大1Hz（必要十分＋省電力）
- 広告：広告ロードが遅延してもコア表示が遅れない（First Direction Timeに影響を与えない）。

### 10.2 バッテリー
- 位置更新の頻度は必要最小限に制御（距離フィルタ/時間間隔）
- バックグラウンド移行時は測位・方位更新を停止（MVP）

### 10.3 可用性
- 検索失敗時はリトライ（段階探索の中で吸収）
- ネットワーク不可時：キャッシュがあれば継続、なければエラー状態表示
- 広告は失敗してもアプリ体験が成立する（広告は必須ではない）。

### 10.4 プライバシー/セキュリティ
- 位置情報は端末内で処理し、サーバ送信しない（MVP方針）
- 解析イベントに位置座標を含めない
- 広告SDK導入時：
  - 収集されうるデータ（端末識別子等）を把握し、プライバシーポリシー・ストア申告（Privacy Nutrition Label）を適切に更新する。
  - パーソナライズ広告/トラッキングを行う場合、iOSの要件（例：同意取得）に準拠する。

---

## 11. 計測（Analytics / KPI）
### 11.1 KPI
- First Direction Time（起動→矢印表示までの秒数）
- Search Success Rate（検索成功率）
- No Result Rate（最大5kmでも0件の割合）
- Heading Unavailable Rate（方位取得不可の割合）
- Target Switch Rate（ターゲット切替回数/分：揺れの指標）
- Ad Fill Rate（広告表示率）
- Ad eCPM / Revenue（収益指標：導入後に定義）

### 11.2 イベント例（位置は含めない）
- `permission_status`（allowed/denied）
- `first_fix_time_ms`
- `poi_search_step`（1km/2km/5km）と結果件数
- `no_poi_max_radius`
- `heading_quality_bucket`（good/ok/poor/unavailable）
- `target_changed`（true/false）
- `ad_loaded` / `ad_failed` / `ad_impression` / `ad_click`

---

## 12. 受け入れ基準（Acceptance Criteria）
1. 位置情報許可済み・周辺に候補がある環境で、起動後に矢印が表示され、端末を回すと矢印方向が追従する。
2. 同条件で、距離がメートル/キロ表示ルールに従い表示される。
3. 検索範囲が1kmで0件の場合、2km→5kmへ順次拡大し、最終的に候補が出れば案内中へ遷移する。
4. 最大5kmでも0件の場合、「見つからない」表示になる。
5. 権限拒否の場合、同一画面で許可を促す表示になり、許可後に案内へ遷移できる。
6. ターゲットが近傍で頻繁に切り替わらず、体感として安定している（ヒステリシスが機能している）。
7. 広告がロード失敗/在庫なし/ネットワーク不可でも、矢印と距離が正常に表示され続ける。
8. 広告表示/非表示で主要UIが大きくレイアウトシフトしない（矢印位置が急変しない）。

---

## 13. リスクと対策（Risks & Mitigations）
- **MapKit検索のヒット率が地域でばらつく**  
  - 対策：検索クエリの改善（日本語/英語併用）、段階探索、将来のOSM/独自データ移行余地を残す。
- **コンパスの誤差（地下・磁気干渉）**  
  - 対策：精度低表示、平滑化、courseフォールバック。
- **遠距離結果になり不満**  
  - 対策：距離表示（本PRDで対応）、必要なら将来「上限距離」設定（MVP外）。
- **広告で視認性が落ちる／誤タップが増える**  
  - 対策：バナーの最小高さ、Safe Area固定、主要UIの余白確保、状態メッセージは広告の上に表示、レイアウト固定で安定。

---

## 14. リリース計画（MVP）
### 14.1 MVP機能一覧
- 位置取得（前景）
- 方位取得（heading＋フォールバック）
- MapKit検索（段階探索 1km/2km/5km）
- 最寄り判定（直線距離）
- 矢印表示（平滑化）
- 距離表示
- 状態表示（権限/測位中/検索中/精度低/見つからない）
- バナー広告表示（画面下部固定、失敗時も体験維持）
- 最低限の計測イベント（コア＋広告）

### 14.2 将来拡張（Backlog）
- 矢印タップでAppleマップに遷移（ナビ開始）
- 距離に加えて「推定徒歩分」表示（MVP外）
- データソース強化（OSM/提携/ユーザー投稿）
- 多言語（英語）
- 広告の最適化（在庫なし時の折りたたみ、頻度制御、ユーザー体験指標に基づく調整）

---

## 15. 実装メモ（Engineering Notes / Non-binding）
- 角度計算は-180～+180に正規化し、短い回転方向を採用する。
- UIのちらつき回避：距離・角度はスロットリング（最大1Hz）＋差分閾値。
- 位置・方位の購読は画面表示中のみ有効化し、非表示時停止。
- 広告ロードはUIスレッドをブロックしない。コア描画完了後に広告を表示できる設計が望ましい。
